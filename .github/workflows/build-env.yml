name: Build & Release Conda Env

on:
  push:
    tags: ['envs-v*']
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. envs-v1)'
        required: true
        default: 'envs-v1'

jobs:
  build-env:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: '3.12'
          miniconda-version: latest
          auto-activate-base: true

      - name: Create conda env
        shell: bash -el {0}
        run: |
          conda create -p ./env python=3.12 -y

      - name: Install dependencies
        shell: bash -el {0}
        run: |
          ./env/bin/pip install -r requirements.txt
          ./env/bin/pip install --ignore-installed fastmcp

      - name: Pack environment
        shell: bash -el {0}
        run: |
          conda install -n base conda-pack -y
          $(conda info --base)/bin/conda-pack -p ./env -o boltzgen_mcp-env.tar.gz --ignore-editable-packages

      - name: Split archive if over 2GB
        run: |
          FILE_SIZE=$(stat -c%s boltzgen_mcp-env.tar.gz)
          echo "Archive size: $FILE_SIZE bytes"
          if [ "$FILE_SIZE" -gt 1900000000 ]; then
            echo "Archive exceeds 1.9GB, splitting into parts..."
            split -b 1900m boltzgen_mcp-env.tar.gz boltzgen_mcp-env.tar.gz.part-
            rm boltzgen_mcp-env.tar.gz
            ls -lh boltzgen_mcp-env.tar.gz.part-*
            echo "SPLIT=true" >> $GITHUB_ENV
          else
            echo "SPLIT=false" >> $GITHUB_ENV
          fi

      - name: Determine release tag
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Conda Environment ${{ steps.tag.outputs.tag }}"
          body: |
            Pre-packaged conda environment for `boltzgen_mcp`.

            **Usage in quick_setup.sh:**
            ```bash
            USE_PACKED_ENVS=1 bash quick_setup.sh
            ```

            **Manual download & extract:**
            If the archive was split into parts, reassemble first:
            ```bash
            cat boltzgen_mcp-env.tar.gz.part-* > boltzgen_mcp-env.tar.gz
            ```
            Then extract:
            ```bash
            mkdir -p env
            tar xzf boltzgen_mcp-env.tar.gz -C env
            source env/bin/activate && conda-unpack
            ```
          files: |
            boltzgen_mcp-env.tar.gz
            boltzgen_mcp-env.tar.gz.part-*
          fail_on_unmatched_files: false
